## SO21b - trabalho 3

**Descrição incompleta**

Nesta parte, será adicionada a multiprogramação ao SO.
O SO irá controlar a execução de mais de um programa.

Para isso, o SO deve ter um descritor para cada processo que irá executar.
Esse descritor deve conter o estado do processador para esse processo, a memória do processo, informações sobre a E/S do processo, e mais informações que considerar necessário.

Não mais será permitido aos programas realizar E/S diretamente no hardware, a E/S será controlada pelo SO.
No SO, os dispositivos de E/S serão simulados por arquivos, um para cada dispositivo (por enquanto, um arquivo com a entrada do teclado e outro com a saida de video).

Na inicialização do SO, ele poderá receber informação sobre vários programas a executar, e inicializar um descritor de processo para cada um deles.

Precisamos de suporte do hardware para evitar que os processos executem algumas instruções. As instruções de E/S (LE, ESCR) e de parada (PARA) serão consideradas privilegiadas. A CPU não vai mais executá-las, gerando interrupção de instrução privilegiada. Essas interrupções serão tratadas pelo SO como se fossem chamadas ao sistema, para realizar E/S e para terminar o programa.

O escalonamento entre processos será realizado nessas chamadas de sistema. Quando um processo realizar E/S ou quando terminar, outro processo será escolhido para execução. Quando todos os processos tiverem terminado, o SO informa o controlador.

Para escolher um processo para executar, o SO altera a memória e o estado do processador da CPU para os do processo escolhido (não precisa alterar o controlador de E/S, porque a CPU não vai mais executar essas instruções).

Quando um processo tentar realizar E/S, como a CPU não vai mais executar essas instruções, quem deverá realizar essas operações é o SO.
Para isso, ele irá acessar o acumulador no descritor do estado do processo, e acessar o arquivo correspondente ao dispositivo.
É o SO também que deve verificar sobre permissão de acesso (se o acesso não for permitido, o processo deve ser morto).
Ele deve também alterar o estado da CPU do processo para que corresponda ao que seria realizado pelo hardware caso a execução da instrução fosse permitida, de forma que quando o processo voltar a executar, será como se a instrução de E/S tivesse sido executada.

Na primeira versão do escalonador, ele é não preemptivo (só executa nas chamadas de sistema realizadas pelo processo em execução), e pode simplesmente escolher o próximo processo, na ordem em que eles estão na tabela de processos.

Para podermos ter um escalonador preemptivo, necessitamos uma garantia que o SO será executado, independentemente do que o processo em execução faça.
Essa forma será por interrupções periódicas; para isso vamos incrementar o relógio.

### Relógio

O relógio ganha funções de despertador.
Ele deve ter suporte a vários despertadores programados.
Um despertador pode ser simples (desperta uma vez e pronto) ou periódico (desperta a cada tanto tempo).
Cada despertador deve ter um dado associado (que serve para identificar o motivo do despertar).
Os despertadores servem para gerar interrupções ao SO.
É o SO quem programa os despertadores sempre que precisar ser avisado da passagem do tempo.
Por enquanto, o SO só vai programar um despertador periódico, para garantir a execução do escalonador.

Quem envia interrupções é a unidade de controle, que deve ser alterada para, depois de informar o relógio que passou mais uma unidade de tempo, perguntar a ele sobre despertadores que tenham despertado, e interromper o SO caso tenha. Deve ser considerado que mais de um despertador pode despertar na mesma hora. O SO deve ser interrompido várias vezes nesse caso.


